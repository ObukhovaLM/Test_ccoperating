# API\_Получение истории операций по картам
**Цель**: сервис предназначен для получения истории операций по картам

**URL**: [endpoint]/api/cards/cardId/history

**Метод**: GET

**Доступ**: авторизованная зона. Сервис вызывается с фронта.
**Входные параметры**: только активные

1. В случае запроса из шага «Краткая история операций в карте»

|**Параметр**|**Тип поля**|**Описание**|**Обязательность**|
|:------------- |:---------------:|:---------------:|:---------------:|
|forceRequest|Boolean|Признак принудительного запроса (получение актуальной инфы из АБС)|Да|
|NumberOfOp|Number|Максимальное количество операций, которое нужно вернуть в ответ. Параметр принимает значение не больше 5|Да|
|begindate|String|10 дней до текущей даты|Да|
|enddate|String|Текущая дата|Да|
|Cardid|Number|ИД карты|Да|

2. В случае запроса из шага «Общая история операций по картам»

|**Параметр**|**Тип поля**|**Описание**|**Обязательность**|
|:------------- |:---------------:|:---------------:|:---------------:|
|forceRequest|Boolean|Признак принудительного запроса (получение актуальной инфы из АБС)|Да|
|begindate|String|Первая дата текущего месяца|Да|
|enddate|String|Последняя дата текущего месяца|Да|
|Cardid|Number|ИД карты|Да|

3. В случае запроса из шага «Выбор периода,  за который необходимо отобразить полную историю».

|**Параметр**|**Тип поля**|**Описание**|**Обязательность**|
|:------------- |:---------------:|:---------------:|:---------------:|
|forceRequest|Boolean|Признак принудительного запроса (получение актуальной инфы из АБС)|Да|
|begindate|String|Указывается клиентом на фронте|Да|
|enddate|String|Указывается клиентом на фронте|Да|
|Cardid|Number|ИД карты|Да|

**Выходные параметры**:

Для всех шагов выходные параметры одинаковые.

|**Параметр**|**Тип поля**|**Описание**|**Обязательность**|
|:------------- |:---------------:|:---------------:|:---------------:|
|data/cards/cardId/history|List[Object]|Список операций|Нет|
|data/cards/cardId/history/date|DateTime|Дата операции|Да|
|data/cards/cardId/history/merchant|String|Название мерчанта|Да|
|data/cards/cardId/history/name|String|Название операции|Да|
|data/cards/cardId/history/sum|Number|Сумма операции|Нет|
|data/cards/cardId/history/currency|DateTime|Валюта операции|Да|
|data/cards/cardId/history/oper\_type|String|Категория операции|Да|
|data/cards/cardId/history/OPERATIONSTATUS|String|Статус операции|Да|

Пример запроса/ответа для краткой история операций в карте

Пример запроса/ответа для общей истории операций в карте

Пример запроса/ответа для выбора периода историй операций в карте
## Основной сценарий (MC)
1. Сервис проверяет входные параметры запроса:
   1. Если получен параметр forceRequest == true, то переход к сценарию AC-1 - Получение истории операций из АБС AllAboutCards.
    2. Иначе, сценарий продолжается.
1. Сервис выполняет поиск истории операций для выбранной карты текущего клиента в БД в таблице client\_cardId\_history.
1. Если в таблице client\_cardId\_history для выбранной карты текущего клиента отсутствуют операции, то переход к сценарию AC-1 - Получение истории операций из АБС AllAboutCards.
1. Сервис сортирует операции в порядке уменьшения дат.
1. Сервис сортирует операции в порядке убывания сумм в пределах дня.
1. Сервис формирует ответ согласно маппингу:

| **Параметр ответа** | **Правило формирования**|
|:------------- |:---------------:|
| data/cards/cardId/history |- |
|data/cards/cardId/history/date| Значение client\_cardId\_history.date |
|data/cards/cardId/history/merchant| Значение client\_cardId\_history. merchant |
|data/cards/cardId/history/name | Значение client\_cardId\_history.name |
|data/cards/cardId/history/sum |Значение client\_cardId\_history.sum|
|data/cards/cardId/history/currency| Значение P если в.currency получено значение ‘RUB’  |
|data/cards/cardId/history/oper\_type| Значение client\_cardId\_history.category |
|data/cards/cardId/history/OPERATIONSTATUS | Значение client\_cardId\_history. OPERATIONSTATUS |

7. Сервис возвращает ответ вызывающей системе.
## Альтернативный сценарий (AC)
1. Получение истории операций из АБС AllAboutCards.
1. Сервис инициирует получение истории операций из AllAboutCards, формируя запрос:

**Атрибут** | **Описание**|
|:------------- |:---------------:|
| clientid |Значение backSystemId, где backSystemCode==’AllAboutCards’, определенное для текущего клиента|
| сardid |Значение Cardid в ответе AllAboutCards|

3. После получения ответа от бэк-системы, выполняется проверка, получена ли информация об истории операций:
   1. Если получен пустой ответ, ошибка или таймаут, то переход к сценарию ЕС-1
3. По событию получения ответа, сервис сохраняет карты в БД в таблицу client\_cardId\_history, согласно маппингу:

| **Поле в таблице client\_cards** | **Поле в ответе AllAboutCards**|
|:------------- |:---------------:|
| id |-  Генерируемое автоматически значение|
|client\_id| Текущий ИД клиента в ДБО |
|сardid| Значение Cardid в ответе AllAboutCards |
|date| Значение transaction\_date в ответе AllAboutCards |
|merchant | Значение place в ответе AllAboutCards |
| sum	|Значение auth\_amount в ответе AllAboutCards  |
|name	|Значение description  в ответе AllAboutCards  |
|currency| Значение P если в auth\_currency в ответе AllAboutCards  получено значение ‘RUB’  |
|category| Значение oper\_type в ответе AllAboutCards |
|OPERATIONSTATUS | Значение ‘Debit’ если в OPERATIONSTATUS в ответе AllAboutCards получено значение ‘Debit’. Значение ‘Credit’ если в OPERATIONSTATUS в ответе AllAboutCards получено значение ‘Credit’. |

5. Сценарий продолжается с шага 4 Основного сценария - получение актуального баланса.
## Исключительные сценарии (EC)
1. У клиента нет истории
1. Сервис формирует ответ, согласно маппингу.

| **Параметр ответа** | **Правило формирования**|
|:------------- |:---------------:|
| data/error/code |Код ошибки|
|data/error/text  |«Операций по карте не совершалось»|

3. API возвращает ответ.
#### Конфигурационные параметры
| **Название конфига** | **Значение**| **Описание**|
|:------------- |:---------------:| :---------------:|
