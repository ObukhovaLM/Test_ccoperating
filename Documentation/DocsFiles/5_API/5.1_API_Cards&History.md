# 5.1 API_Получение списка карт и историй 
**Цель:** сервис предназначен для получения списка карт клиента и истории по ним.
**Цель:** сервис предназначен для получения списка карт клиента и истории по
ним.

| **Метод**                                                        | **Описание**                                                 |
|------------------------------------------------------------------|--------------------------------------------------------------|
| <a href=#m1>GET [endpoint]/api/cards/list</a>       | Метод для получения списка карт и актуальных балансов по ним |
| <a href=#m2>GET [endpoint]/api/cards/history</a> | Метод для получения историй операций по картам               |

## <a id="m1"></a>**URL:** [endpoint]/api/cards/list

**Метод:** GET

**Доступ:** авторизованная зона. Сервис вызывается с фронта.

**Входные параметры:** нет или (только активные)

| **Параметр** | **Тип поля** | **Описание**                                                       | **Обязательность** |
|--------------|--------------|--------------------------------------------------------------------|--------------------|
| forceRequest | Boolean      | Признак принудительного запроса (получение актуальной инфы из АБС) | Да                 |

**Выходные параметры:**

| **Параметр**            | **Тип поля** | **Описание**                                           | **Обязательность** |
|-------------------------|--------------|--------------------------------------------------------|--------------------|
| data/cards              | List[Object] | Список карт                                            | Нет                |
| data/cards/cardDesign   | String       | Дизайн карты (урл до картинки)                         | Нет                |
| data/cards/name         | String       | Наименование карты                                     | Да                 |
| data/cards/paySystem    | String       | Платежная система                                      | Да                 |
| data/cards/maskedNumber | String       | Маскированный номер карты в формате XXXXXX\*\*\*\*XXXX | Да                 |
| data/cards/cardtype     | String       | Тип карты (debit, credit)                              | Да                 |
| data/cards/balance      | Number       | Баланс карты                                           | Да                 |
| data/cards/currency     | String       | Валюта карты                                           | Да                 |
| data/cards/status       | String       | Статус карты (active, blocked, inactive)               | Да                 |

Пример запроса/ответа:

## Основной сценарий (MC)

1.  Сервис проверяет входные параметры запроса:

    1.  Если получен параметр forceRequest == true, то переход к сценарию <a href=#ac1>AC-1</a> -
        Получение карт из АБС AllAboutCards.

    2.  Иначе, сценарий продолжается.

2.  Сервис выполняет поиск карт для текущего клиента в БД в таблице
    client_cards.

3.  Если в таблице client_cards для текущего клиента отсутствуют карты, то
    переход к сценарию <a href=#ac1>AC-1</a> - Получение карт из АБС AllAboutCards.

4.  <a id="mc4"></a>Сервис инициирует получение актуального баланса по каждой карте в рамках
    сценария <a href=#sc1>SC-1</a>

5.  <a id="mc5"></a>Сервис сортирует карты в порядке уменьшения значения баланса.

6.  Сервис формирует ответ согласно маппингу:

| **Параметр ответа**     | **Правило формирования**                                                                                                                                                                      |
|-------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| data/cards              | -                                                                                                                                                                                             |
| data/cards/cardDesign   | Значение client_cards.card_design                                                                                                                                                             |
| data/cards/name         | Значение client_cards.card_name в ответе AllAboutCards                                                                                                                                        |
| data/cards/paySystem    | Значение client_cards.payment_system в ответе AllAboutCards                                                                                                                                   |
| data/cards/maskedNumber | Значение client_cards.masked_cardnumber                                                                                                                                                       |
| data/cards/cardtype     | Если значение client_cards.card_type                                                                                                                                                          |
| data/cards/balance      | Значение client_cards.balance в ответе AllAboutCards                                                                                                                                          |
| data/cards/currency     | Значение ₽ если в cardcurrencydesc получено значение ‘RUB’ Значение ‘**\$**’ если в cardcurrencydesc получено значение ‘USD’ Значение ‘**€**’ если в cardcurrencydesc получено значение ‘EUR’ |
| data/cards/status       | Значение client_cards.status_text                                                                                                                                                             |

7. Сервис возвращает ответ вызывающей системе.

## Альтернативный сценарий (AC)

### <a id="ac1"></a>АС-1. Получение карт из АБС AllAboutCards.

1.  Сервис инициирует получение карт клиента из AllAboutCards, формируя запрос:

| **Атрибут** | **Описание**                                                                                  |
|-------------|-----------------------------------------------------------------------------------------------|
| clientid    | Значение backSystemId, где backSystemCode==’AllAboutCards’, определенное для текущего клиента |

2. После получения ответа от бэк-системы,выполняется проверка, получена ли
    информация о картах:

    1.  Если получен пустой ответ, ошибка или таймаут, то переход к сценарию
        <a href=#ec1>ЕС-1</a>

3. По событию получения ответа, сервис сохраняет карты в БД в таблицу
    client_cards, согласно маппингу:

| **Поле в таблице client_cards** | **Поле в ответе AllAboutCards**                                                                                                                                                                                                                                          |
|---------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| id                              | - Генерируемое автоматически значение                                                                                                                                                                                                                                    |
| client_id                       | - Текущий ИД клиента в ДБО                                                                                                                                                                                                                                               |
| card_design                     | Значение carddesign в ответе AllAboutCards                                                                                                                                                                                                                               |
| card_name                       | Значение Print_Name_Product в ответе AllAboutCards                                                                                                                                                                                                                       |
| payment_system                  | Значение paysystem в ответе AllAboutCards                                                                                                                                                                                                                                |
| masked_cardnumber               | Значение mainvirtnum в ответе AllAboutCards в формате XXXXXX\*\*\*\*XXXX                                                                                                                                                                                                 |
| card_type                       | Если значение isCredit == true, то вернуть значение ‘credit’, иначе ‘debit’                                                                                                                                                                                              |
| currency_code                   | Значение cardcurrencydesc                                                                                                                                                                                                                                                |
| currency_text                   | Значение ₽ если в cardcurrencydesc в ответе AllAboutCards получено значение ‘RUB’ Значение ‘**\$**’ если в cardcurrencydesc в ответе AllAboutCards получено значение ‘USD’ Значение ‘**€**’ если в cardcurrencydesc в ответе AllAboutCards получено значение ‘EUR’       |
| status_code                     | Значение status в ответе AllAboutCards                                                                                                                                                                                                                                   |
| status_text                     | Значение ‘Активна’ если в status в ответе AllAboutCards получено значение ‘active’ Значение ‘Заблокирована’ если в status в ответе AllAboutCards получено значение ‘blocked’ Значение ‘Неактивирована’ если в status в ответе AllAboutCards получено значение ‘inactive’ |

4. Сценарий продолжается с шага <a href=#mc4>4 Основного сценария</a> - получение актуального
    баланса.

## Cуб-сценарий (SC)

### <a id="sc1"></a>SС-1. Получение баланса из АБС OnlyBalanceCards.

1.  Сервис инициирует получение карт клиента из OnlyBalanceCards, формируя
    запрос:

| **Атрибут** | **Описание**                                                                                     |
|-------------|--------------------------------------------------------------------------------------------------|
| clientid    | Значение backSystemId, где backSystemCode==’OnlyBalanceCards’, определенное для текущего клиента |
| cardnum     | Значение mainvirtnum в ответе AllAboutCards                                                      |

2. После получения ответа от бэк-системы,выполняется проверка, получена ли
    информация о балансе карты:

    1.  Если получен пустой ответ, ошибка или таймаут, то карта исключается из
        списка карт для отображения клиенту.

3. По событию получения ответа, сервис обновляет информацию о балансе карты в
    БД в таблице client_cards, согласно маппингу:

| **Поле в таблице client_cards** | **Поле в ответе OnlyBalanceCards**         |
|---------------------------------|--------------------------------------------|
| balance                         | Значение balance в ответе OnlyBalanceCards |

4. Сценарий продолжается с шага <a href=#mc5>5 Основного сценария</a> - сортировка карт.

## Исключительные сценарии (EC)

### ЕС-1. У клиента нет карт

1.  Сервис формирует ответ, согласно маппингу.

| **Параметр ответа** | **Правило формирования**                                              |
|---------------------|-----------------------------------------------------------------------|
| data/error/code     | Код ошибки                                                            |
| data/error/text     | “У вас нет ни одной карты! Чтобы открыть карту перейдите в раздел...” |

2. API возвращает ответ.



## <a id="m2"></a>**URL:** [endpoint]/api/cards/history

**Метод:** GET

**Доступ:** авторизованная зона. Сервис вызывается с фронта.

**Входные параметры:** нет или (только активные)

| **Параметр** | **Тип поля** | **Описание**                                                       | **Обязательность** |
|--------------|--------------|--------------------------------------------------------------------|--------------------|
| forceRequest | Boolean      | Признак принудительного запроса (получение актуальной инфы из АБС) | Да                 |
| begindate    | String       | Дата начала периода за который запрашивается информация            | Да                 |
| enddate      | String       | Дата окончания периода за который запрашивается информация         | Да                 |
| numberOfOps  | Number       | Максимальное количество операций, которое нужно вернуть в ответ    | Да                 |
| cards        | List[Object] | Список карт по которым запрашивается история                       | Да                 |

**Выходные параметры:**

| **Параметр**                           | **Тип поля** | **Описание**                                                                                                                                                                                                                                                                       | **Обязательность** |
|----------------------------------------|--------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|--------------------|
| data/ cards/history/maskedNumber       | String       | Маскированный номер карты в формате XXXXXX\*\*\*\*XXXX                                                                                                                                                                                                                             | Да                 |
| data/ cards/history/transactionDate    | DateTime     | Дата операции                                                                                                                                                                                                                                                                      | Да                 |
| data/cards/history/authAmount          | Number       | Сумма операции в валюте транзакции                                                                                                                                                                                                                                                 | Да                 |
| data/cards/history/authCurrency        | String       | Валюта операции Значение ₽ если в cardcurrencydesc в ответе AllAboutCards получено значение ‘RUB’ Значение ‘**\$**’ если в cardcurrencydesc в ответе AllAboutCards получено значение ‘USD’ Значение ‘**€**’ если в cardcurrencydesc в ответе AllAboutCards получено значение ‘EUR’ | Да                 |
| data/cards/history/cardSign            | String       | Знак операции, принимает значения 'Debit' или 'Credit'                                                                                                                                                                                                                             | Да                 |
| data/cards/history/description         | String       | Назначение операции                                                                                                                                                                                                                                                                | Да                 |
| data/cards/history/operType            | String       | Тип операции, IBN - оплата услуг в ИБ, POS - POS, ATM - наличка, BAL - платный запрос баланса карты, P2P - P2P, KOM - комиссия, KAS - наличка, ACC - перевод по счету.                                                                                                             | Да                 |
| data/cards/history/operationStatus     | String       | Статус операции                                                                                                                                                                                                                                                                    | Да                 |
| data/cards/history/transactionAmount   | Number       | Сумма операции в валюте карты                                                                                                                                                                                                                                                      | Да                 |
| data/cards/history/transactionCurrency | String       | Валюта карты Значение ₽ если в cardcurrencydesc в ответе AllAboutCards получено значение ‘RUB’ Значение ‘**\$**’ если в cardcurrencydesc в ответе AllAboutCards получено значение ‘USD’ Значение ‘**€**’ если в cardcurrencydesc в ответе AllAboutCards получено значение ‘EUR’    | Да                 |


## Основной сценарий (MC)

1.  Сервис проверяет входные параметры запроса:

    1.  Если получен параметр forceRequest == true, то переход к сценарию <a href=#ac1_>AC-1</a> -
        Получение истории операций из АБС AllAboutCards.

    2.  Иначе, сценарий продолжается.

2.  Сервис выполняет поиск историй операций для списка карт из запроса для
    текущего клиента в БД в таблице card_history.

3.  Если в таблице card_history для запрашиваемого списка карт отсутствуют
    операции, то переход к сценарию <a href=#ac1_>AC-1</a> - Получение истории операций из АБС
    AllAboutCards.

4.  <a id="mc1_"></a>Сервис сортирует операции по дате совершения транзакций.

5.  Сервис формирует ответ согласно маппингу:

| **Параметр ответа**                    | **Правило формирования**                   |
|----------------------------------------|--------------------------------------------|
| data/cards/history/maskedNumber        | Значение card_history.masked_number        |
| data/cards/history/transactionDate     | Значение card_history.transaction_date     |
| data/cards/history/authAmount/         | Значение card_history.auth_amount          |
| data/cards/history/authCurrency        | Значение card_history.auth_currency        |
| data/cards/history/cardSign            | Значение card_history.card_sign            |
| data/cards/history/description         | Значение card_history.description          |
| data/cards/history/operType            | Значение card_history.oper_type            |
| data/cards/history/operationStatus     | Значение card_history.operation_status     |
| data/cards/history/transactionAmount   | Значение card_history.transaction_amount   |
| data/cards/history/transactionCurrency | Значение card_history.transaction_currency |
| data/cards/history/mcc                 | Значение card_history. mcc                 |

6. Сервис возвращает ответ вызывающей системе.

## Альтернативный сценарий (AC)

### <a id="ac1_"></a>АС-1. Получение истории операций из АБС AllAboutCards.

1.  Сервис инициирует получение истории операций из AllAboutCards, формируя
    запрос:

| **Атрибут** | **Описание**                                                     |
|-------------|------------------------------------------------------------------|
| cardnumber  | Виртуальный или полный номер карты                               |
| begindate   | Дата начала периода за который запрашивается информация          |
| enddate     | Дата окончания периода за который запрашивается информация       |
| NumberOfOps |  Максимальное количество операций, которое нужно вернуть в ответ |
| Cardid      |  ИД карты, используется как альтернатива cardnumber              |

2. После получения ответа от бэк-системы, выполняется проверка, получена ли
история операций:
    1.  Если получен пустой ответ, ошибка или таймаут, то переход к сценарию <a href=#ec1_>ЕС-1</a>
    2.  По событию получения ответа, сервис сохраняет истории по картам в БД в
    таблицу card_history, согласно маппингу:

| **Поле в таблице card_history** | **Поле в ответе AllAboutCards**                                          |
|---------------------------------|--------------------------------------------------------------------------|
| masked_number                   | Значение mainvirtnum в ответе AllAboutCards в формате XXXXXX\*\*\*\*XXXX |
| transaction_date                | Значение transaction_date в ответе AllAboutCards                         |
| auth_amount                     | Значение auth_amount в ответе AllAboutCards                              |
| auth_currency                   | Значение auth_currency в ответе AllAboutCards                            |
| card_sign                       | Значение card_sign в ответе AllAboutCards                                |
| description                     | Значение description в ответе AllAboutCards                              |
| oper_type                       | Значение oper_type в ответе AllAboutCards                                |
| operation_status                | Значение operation_status в ответе AllAboutCards                         |
| transaction_amount              | Значение transaction_amount в ответе AllAboutCards                       |
| transaction_currency            | Значение transaction_currency status в ответе AllAboutCards              |

3. Сценарий продолжается с шага <a href=#mc1_>4 Основного сценари</a>я – сортировка операций по
    дате совершения транзакций.

## Исключительные сценарии (EC)

### <a id="ec1_"></a>EС-1. По запрашиваемому списку карт истории отсутствуют

1.  Сервис формирует ответ, согласно маппингу.

| **Параметр ответа** | **Правило формирования**                   |
|---------------------|--------------------------------------------|
| data/error/code     | Код ошибки                                 |
| data/error/text     | “Операции по выбранным картам отсутствуют” |

2. API возвращает ответ.
